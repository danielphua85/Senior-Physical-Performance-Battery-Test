<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Senior Physical Performance Battery Test</title>
  <style>
    :root{
      --card:#111b2e;
      --muted:#a8b3cf;
      --text:#e8eeff;
      --ok:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.12);
      --shadow: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #081020, #0b1220 45%, #070d18);
      color:var(--text);
    }
    header{
      padding:16px 16px 10px;
      position:sticky; top:0; backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75); border-bottom: 1px solid var(--border);
      z-index: 20;
    }
    header .title{font-weight:800; font-size:16px}
    header .sub{color:var(--muted); font-size:12px; margin-top:4px}
    main{padding:14px; max-width: 920px; margin:0 auto;}
    .card{
      background: rgba(17,27,46,.82);
      border:1px solid var(--border);
      border-radius: 16px;
      padding:16px;
      margin: 12px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1,h2{margin:0 0 10px}
    h1{font-size:18px}
    h2{font-size:16px}
    p,li{line-height:1.4}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex: 1 1 220px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid var(--border); background:#0c1426; color: var(--text);
      outline:none;
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:0; border-radius: 12px;
      padding: 12px 14px; font-weight:800;
      cursor:pointer;
      background: #182746; color: var(--text);
      border: 1px solid var(--border);
    }
    button.primary{background: linear-gradient(90deg, #16a34a, #22c55e); color:#06110a; border:0}
    button.danger{background: #2a1420; border:1px solid rgba(251,113,133,.35)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .small{font-size:12px}
    .hr{height:1px; background: var(--border); margin: 12px 0}
    .notice{
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
      padding: 10px 12px; border-radius: 12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border); background: rgba(12,20,38,.8);
      font-size:12px; color: var(--muted);
    }
    .pill strong{color: var(--text)}
    .badge{
      display:inline-block; padding: 6px 10px; border-radius: 999px;
      border:1px solid var(--border); background: rgba(12,20,38,.85);
      font-size: 12px; color: var(--muted);
      margin-right:8px; margin-top:6px;
    }
    .hidden{display:none !important}

    /* Camera stage (sticky-like within page) */
    .stageWrap{
      position: sticky;
      top: 74px; /* below header */
      z-index: 15;
      margin: 12px 0;
    }
    .stage{
      position:relative;
      width:100%;
      max-width: 520px;
      margin: 0 auto;
      aspect-ratio: 9/16;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#000;
      box-shadow: 0 18px 40px var(--shadow);
      touch-action: none; /* enable custom pinch */
    }
    video,canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: contain; /* show whole body, less crop */
      background:#000;
    }

    .hudTop{
      position:absolute; left:10px; right:10px; top:10px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .hudChip{
      pointer-events:auto;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:12px;
      color: var(--text);
      backdrop-filter: blur(8px);
      display:inline-flex; gap:8px; align-items:center;
    }
    .hudChip strong{font-weight:900}
    .hudBottom{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:grid; gap:8px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 10px;
      backdrop-filter: blur(10px);
    }
    .hudRow{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .hudBtns{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .miniBtn{
      padding:10px 12px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
    }
    .miniBtn.primary{background: linear-gradient(90deg, #16a34a, #22c55e); color:#06110a; border:0}
    .miniBtn.danger{background: #2a1420; border:1px solid rgba(251,113,133,.35)}
    .miniBtn.ghost{background: rgba(24,39,70,.85)}
    .kpis{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi{
      min-width: 98px;
      display:flex; flex-direction:column;
      gap:2px;
    }
    .kpi .v{font-weight:950; font-size:16px}
    .kpi .t{font-size:11px; color: var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    .slider{ width: 160px; }

    /* Layout below stage */
    .grid2{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:820px){ .grid2{grid-template-columns: 1fr 1fr} }
  </style>
</head>
<body>
<header>
  <div class="title">Senior Physical Performance Battery Test</div>
  <div class="sub">Welcome to Coach Daniel SPPB Test • On-device only • Export PDF</div>
</header>

<main>

  <!-- Welcome -->
  <section id="screenWelcome" class="card">
    <h1>Welcome to Coach Daniel SPPB Test</h1>
    <p class="muted">Fitness screening & education only. Not a medical diagnosis.</p>
    <div class="notice small">
      <strong>Stop immediately</strong> if dizziness, chest pain, severe shortness of breath, sharp pain, or you feel unsafe.
    </div>
    <div class="btns">
      <button class="primary" id="btnStart">Start</button>
      <button id="btnLoadLast">Load last results</button>
    </div>
  </section>

  <!-- Register -->
  <section id="screenRegister" class="card hidden">
    <h1>Registration & Consent</h1>
    <div class="row">
      <div>
        <label>Name</label>
        <input id="fName" placeholder="Full name"/>
      </div>
      <div>
        <label>Age</label>
        <input id="fAge" type="number" min="50" max="110" placeholder="e.g., 72"/>
      </div>
      <div>
        <label>Gender</label>
        <select id="fGender">
          <option value="">Select</option>
          <option value="men">Male</option>
          <option value="women">Female</option>
        </select>
      </div>
      <div>
        <label>HP No.</label>
        <input id="fPhone" inputmode="numeric" placeholder="e.g., 98163603"/>
      </div>
    </div>

    <div class="hr"></div>

    <h2>Safety Guidelines</h2>
    <ul class="small">
      <li>Use a <strong>stable chair</strong> (no wheels) on a non-slip floor.</li>
      <li>Wear <strong>proper footwear</strong> and clear obstacles.</li>
      <li>Have a caregiver/trainer nearby if you are frail or unsteady.</li>
      <li>Stop immediately if you feel dizzy, chest pain, severe breathlessness, sharp pain, or unsafe.</li>
    </ul>

    <div class="hr"></div>

    <h2>Consent</h2>
    <p class="small muted">This is a non-diagnostic screening tool. Results are general indicators and not medical advice.</p>

    <div class="card" style="margin:0; padding:12px; background: rgba(12,20,38,.6)">
      <label><input type="checkbox" id="cAgree1"> I understand this is not a medical diagnosis.</label>
      <label><input type="checkbox" id="cAgree2"> I confirm it is safe for me to attempt these tests today.</label>
      <label><input type="checkbox" id="cAgree3"> I will stop immediately if I feel unwell or unstable.</label>
    </div>

    <div class="btns">
      <button id="btnBack1">Back</button>
      <button class="primary" id="btnContinue1">Continue</button>
    </div>
  </section>

  <!-- Guide -->
  <section id="screenGuide" class="card hidden">
    <h1>Test Guide</h1>
    <div class="grid2">
      <div class="card" style="margin:0; background: rgba(12,20,38,.55)">
        <h2>Chair Stand Rules</h2>
        <ul class="small">
          <li>Phone on tripod/table around chest height.</li>
          <li>Stand roughly <strong>1.5–2.5m</strong> away (adjust so whole body fits).</li>
          <li><strong>Arms crossed on chest</strong> during BOTH standing and sitting.</li>
          <li>Calibrate:
            <div>• <strong>Position A</strong> = Standing, arms crossed</div>
            <div>• <strong>Position B</strong> = Sitting, arms crossed</div>
          </li>
          <li>Then press <strong>Start</strong>. Reps count when moving <strong>B → A</strong> (sit to stand).</li>
        </ul>
      </div>

      <div class="card" style="margin:0; background: rgba(12,20,38,.55)">
        <h2>Single-Leg Balance Rules</h2>
        <ul class="small">
          <li>Test <strong>Left leg</strong> first, then <strong>Right leg</strong>.</li>
          <li>Calibrate <strong>Position A</strong> when stable on one leg.</li>
          <li>Press <strong>Start</strong> → timer begins after stable → stops when balance is lost.</li>
        </ul>

        <div class="notice small">Tip: If AI struggles, use “Manual input” buttons.</div>

        <div class="btns">
          <button class="primary" id="btnContinue2">Proceed to Tests</button>
          <button id="btnBack2">Back</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Tests -->
  <section id="screenTests" class="hidden">

    <!-- Sticky Camera Stage -->
    <div class="stageWrap">
      <div class="stage" id="stage">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>

        <!-- TOP HUD -->
        <div class="hudTop">
          <div class="hudChip"><strong id="hudMode">Chair</strong> <span id="hudSub" class="muted">Ready</span></div>
          <div class="hudChip">Conf: <strong id="kpiConf">—</strong></div>
        </div>

        <!-- BOTTOM HUD -->
        <div class="hudBottom">
          <div class="hudRow">
            <div class="kpis">
              <div class="kpi">
                <div class="v" id="kpiStatus">—</div>
                <div class="t">Status</div>
              </div>
              <div class="kpi">
                <div class="v" id="kpiTimer">0.0s</div>
                <div class="t">Timer</div>
              </div>
              <div class="kpi">
                <div class="v" id="kpiReps">0</div>
                <div class="t">Reps</div>
              </div>
            </div>
          </div>

          <div class="hudRow">
            <div class="hudBtns">
              <button class="miniBtn ghost" id="btnCalA">Calibrate A</button>
              <button class="miniBtn ghost" id="btnCalB">Calibrate B</button>
              <button class="miniBtn primary" id="btnStartTest">Start</button>
              <button class="miniBtn danger" id="btnStopTest">Stop</button>
            </div>
          </div>

          <div class="hudRow">
            <div class="hudChip" style="flex:1 1 auto; justify-content:space-between">
              <span>Camera</span>
              <select id="cameraFacing" style="width:auto; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.3); color:var(--text)">
                <option value="environment" selected>Back</option>
                <option value="user">Front</option>
              </select>
              <button class="miniBtn ghost" id="btnRestartCam" style="padding:8px 10px">Restart</button>
            </div>
          </div>

          <div class="hudRow">
            <div class="hudChip" style="flex:1 1 auto; justify-content:space-between">
              <span>Zoom</span>
              <input class="slider" id="zoomSlider" type="range" min="1" max="1" step="0.1" value="1" />
              <span class="muted" id="zoomLabel">1.0×</span>
            </div>
          </div>

          <div class="hudRow">
            <div class="hudChip" style="flex:1 1 auto">
              <span class="muted" id="calibInfo">A: — | B: —</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Below camera: settings + progress -->
    <section class="card">
      <h1>Tests</h1>

      <div class="grid2">
        <div class="card" style="margin:0; background: rgba(12,20,38,.55)">
          <h2>Test Settings</h2>

          <label>Test Mode</label>
          <select id="testMode">
            <option value="chair" selected>Chair Stand</option>
            <option value="balance">Single-Leg Balance</option>
          </select>

          <div id="chairOptions" style="margin-top:10px">
            <label>Protocol</label>
            <select id="chairProtocol">
              <option value="30">30 seconds</option>
              <option value="60">1 minute</option>
            </select>

            <div class="notice small" style="margin-top:10px">
              Chair Stand: <strong>Arms crossed on chest</strong> for both standing & sitting during calibration and test.
            </div>

            <div class="btns">
              <button id="btnManualChair">Manual Reps</button>
            </div>
          </div>

          <div id="balanceOptions" class="hidden" style="margin-top:10px">
            <label>Leg to Test</label>
            <select id="balanceLeg">
              <option value="left">Left leg first</option>
              <option value="right">Right leg</option>
            </select>

            <div class="notice small" style="margin-top:10px">
              Balance: Calibrate A when stable on one leg. Start → timer will stop when balance is lost.
            </div>

            <div class="btns">
              <button id="btnManualBalance">Manual Time</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="btns">
            <button id="btnBack3">Back</button>
            <button class="primary" id="btnFinish" disabled>Finish & View Results</button>
          </div>
        </div>

        <div class="card" style="margin:0; background: rgba(12,20,38,.55)">
          <h2>Progress</h2>
          <div class="row">
            <span class="pill"><strong>Chair:</strong> <span id="pChair">Not done</span></span>
            <span class="pill"><strong>Balance L:</strong> <span id="pBalL">Not done</span></span>
            <span class="pill"><strong>Balance R:</strong> <span id="pBalR">Not done</span></span>
          </div>

          <div class="hr"></div>
          <div class="notice small">
            If camera cannot detect: improve lighting, ensure full body visible, stand nearer (1.5–2.5m), and keep background still.
          </div>
        </div>
      </div>
    </section>

  </section>

  <!-- Results -->
  <section id="screenResults" class="card hidden">
    <h1>Results Summary</h1>
    <div id="resultsBlock" class="card" style="margin:0; background: rgba(12,20,38,.55)"></div>

    <div class="btns" style="justify-content:space-between">
      <div class="btns">
        <button id="btnExport">Export Results (JSON)</button>
        <button id="btnExportPdf">Export Results (PDF)</button>
        <button id="btnCopyContact" class="primary">Copy Coach Contact</button>
      </div>
      <button id="btnRestart">Restart</button>
    </div>

    <p class="small muted">
      This is for education and screening only and does not diagnose medical conditions.
      If you have frequent falls or concerning symptoms, consult a healthcare professional.
    </p>
  </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
const $ = (id)=>document.getElementById(id);
const SCREENS = ["screenWelcome","screenRegister","screenGuide","screenTests","screenResults"];
const show = (screenId)=> SCREENS.forEach(s => $(s).classList.toggle("hidden", s!==screenId));
const now = ()=>performance.now();
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
function escapeHtml(s){
  return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

const app = {
  user:null,
  detector:null,
  stream:null,
  camOn:false,
  lastPose:null,
  poseConf:0,
  rafId:null,
  stopFlag:false,
  track:null,
  zoomCap:null,
  zoomVal:1,
  chair:{ protocolSec:30, yA:null, yB:null, reps:0, done:false, started:false, startTs:0, lastState:"unknown", lastSwitchTs:0 },
  balance:{
    left:{ yA:null, time:null, done:false },
    right:{ yA:null, time:null, done:false },
    runningLeg:null, started:false, stableStarted:false, startTs:0, stableTs:0, _x0:null, _a0:null
  }
};

const chair30Norms = {
  "60-64": { men:14, women:12 },
  "65-69": { men:12, women:11 },
  "70-74": { men:12, women:10 },
  "75-79": { men:11, women:10 },
  "80-84": { men:10, women:9  },
  "85-89": { men:8 , women:8  },
  "90-94": { men:7 , women:4  },
};
function ageBand30(age){
  if(age>=60 && age<=64) return "60-64";
  if(age>=65 && age<=69) return "65-69";
  if(age>=70 && age<=74) return "70-74";
  if(age>=75 && age<=79) return "75-79";
  if(age>=80 && age<=84) return "80-84";
  if(age>=85 && age<=89) return "85-89";
  if(age>=90 && age<=94) return "90-94";
  return null;
}
function chair1MinRef(age){
  if(age>=60 && age<=69) return {low:11, high:17};
  if(age>=70 && age<=79) return {low:10, high:15};
  if(age>=80) return {low:8, high:14};
  return null;
}
function interpretBalance(sec){
  if(sec==null) return {label:"—", cls:"muted"};
  if(sec<5)  return {label:"< 5s: higher fall risk", cls:"bad"};
  if(sec<10) return {label:"< 10s: needs improvement", cls:"warn"};
  if(sec>30) return {label:"> 30s: generally lower fall risk", cls:"ok"};
  return {label:"10–30s: moderate", cls:"warn"};
}

const video = $("video");
const canvas = $("canvas");
const ctx = canvas.getContext("2d");

async function stopStream(){
  if(app.stream){
    for(const t of app.stream.getTracks()) t.stop();
    app.stream = null;
  }
  app.track = null;
  app.zoomCap = null;
  app.camOn = false;
  video.srcObject = null;
}

async function loadModel(){
  if(app.detector) return;
  await tf.setBackend("webgl");
  await tf.ready();
  app.detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING, enableSmoothing:true, trackerType:"boundingBox" }
  );
}

async function startCamera(){
  app.stopFlag = true;
  cancelAnimationFrame(app.rafId);
  await stopStream();

  const facing = $("cameraFacing").value || "environment";

  let stream = null;
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{
        facingMode: { ideal: facing },
        width:{ideal:720},
        height:{ideal:1280}
      }
    });
  }catch(e1){
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        audio:false,
        video:{ facingMode: facing, width:{ideal:720}, height:{ideal:1280} }
      });
    }catch(e2){
      stream = await navigator.mediaDevices.getUserMedia({ audio:false, video:true });
    }
  }

  app.stream = stream;
  video.srcObject = stream;
  await video.play();
  app.camOn = true;

  canvas.width = video.videoWidth || 720;
  canvas.height = video.videoHeight || 1280;

  const tracks = stream.getVideoTracks();
  app.track = tracks?.[0] || null;
  setupZoomControls();

  $("hudSub").textContent = "Loading model…";
  await loadModel();
  $("hudSub").textContent = (facing==="environment") ? "Back cam ready" : "Front cam ready";

  app.stopFlag = false;
  loop();
}

function setupZoomControls(){
  const slider = $("zoomSlider");
  const label  = $("zoomLabel");
  slider.value = "1";
  label.textContent = "1.0×";
  app.zoomVal = 1;

  if(!app.track || !app.track.getCapabilities){
    slider.min = "1"; slider.max = "1"; slider.step="0.1";
    slider.disabled = true;
    return;
  }

  const caps = app.track.getCapabilities();
  if(!caps || !caps.zoom){
    slider.min = "1"; slider.max = "1"; slider.step="0.1";
    slider.disabled = true;
    return;
  }

  slider.disabled = false;
  app.zoomCap = caps.zoom;

  slider.min = String(caps.zoom.min);
  slider.max = String(caps.zoom.max);
  slider.step = String(caps.zoom.step || 0.1);

  const z = caps.zoom.min;
  slider.value = String(z);
  label.textContent = (Math.round(z*10)/10).toFixed(1) + "×";
  app.zoomVal = z;

  applyZoom(z);

  slider.oninput = ()=>{
    const v = Number(slider.value);
    app.zoomVal = v;
    label.textContent = (Math.round(v*10)/10).toFixed(1) + "×";
    applyZoom(v);
  };
}

async function applyZoom(z){
  if(!app.track) return;
  try{
    await app.track.applyConstraints({ advanced: [{ zoom: z }] });
  }catch(e){}
}

/* Pinch zoom */
const stage = $("stage");
const pointers = new Map();
let pinchStartDist = null;
let pinchStartZoom = null;
function dist(a,b){
  const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
  return Math.hypot(dx,dy);
}
stage.addEventListener("pointerdown",(e)=>{
  stage.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, e);
  if(pointers.size===2 && app.zoomCap){
    const [p1,p2] = [...pointers.values()];
    pinchStartDist = dist(p1,p2);
    pinchStartZoom = app.zoomVal;
  }
});
stage.addEventListener("pointermove",(e)=>{
  if(!pointers.has(e.pointerId)) return;
  pointers.set(e.pointerId, e);
  if(pointers.size===2 && app.zoomCap){
    const [p1,p2] = [...pointers.values()];
    const d = dist(p1,p2);
    if(!pinchStartDist || !pinchStartZoom) return;
    const scale = d / pinchStartDist;
    let z = pinchStartZoom * scale;
    z = clamp(z, app.zoomCap.min, app.zoomCap.max);
    app.zoomVal = z;
    $("zoomSlider").value = String(z);
    $("zoomLabel").textContent = (Math.round(z*10)/10).toFixed(1) + "×";
    applyZoom(z);
  }
});
stage.addEventListener("pointerup",(e)=>{
  pointers.delete(e.pointerId);
  if(pointers.size<2){ pinchStartDist=null; pinchStartZoom=null; }
});
stage.addEventListener("pointercancel",(e)=>{
  pointers.delete(e.pointerId);
  if(pointers.size<2){ pinchStartDist=null; pinchStartZoom=null; }
});

function kp(pose, name){ return pose?.keypoints?.find(k=>k.name===name) || null; }
function poseConfidence(pose){
  const names = ["left_hip","right_hip","left_shoulder","right_shoulder","left_ankle","right_ankle"];
  let s=0,n=0;
  for(const nm of names){
    const k = kp(pose,nm);
    if(k && (k.score??0)>0.2){ s+=(k.score??0); n++; }
  }
  return n? s/n : 0;
}
function midY(pose){
  const lh=kp(pose,"left_hip"), rh=kp(pose,"right_hip");
  const ls=kp(pose,"left_shoulder"), rs=kp(pose,"right_shoulder");
  const hipOk=lh&&rh&&lh.score>0.2&&rh.score>0.2;
  const shOk=ls&&rs&&ls.score>0.2&&rs.score>0.2;
  if(hipOk) return (lh.y+rh.y)/2;
  if(shOk) return (ls.y+rs.y)/2;
  return null;
}
function midX(pose){
  const lh=kp(pose,"left_hip"), rh=kp(pose,"right_hip");
  const ls=kp(pose,"left_shoulder"), rs=kp(pose,"right_shoulder");
  const hipOk=lh&&rh&&lh.score>0.2&&rh.score>0.2;
  const shOk=ls&&rs&&ls.score>0.2&&rs.score>0.2;
  if(hipOk) return (lh.x+rh.x)/2;
  if(shOk) return (ls.x+rs.x)/2;
  return null;
}

function drawPose(pose){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="rgba(0,0,0,.10)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  if(!pose) return;

  for(const k of pose.keypoints){
    if((k.score??0)<0.25) continue;
    ctx.beginPath();
    ctx.arc(k.x,k.y,5,0,Math.PI*2);
    ctx.fillStyle="rgba(34,197,94,.95)";
    ctx.fill();
  }

  if($("testMode").value==="chair"){
    if(app.chair.yA!=null){
      ctx.strokeStyle="rgba(74,222,128,.95)"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(0,app.chair.yA); ctx.lineTo(canvas.width,app.chair.yA); ctx.stroke();
      ctx.fillStyle="rgba(74,222,128,.95)";
      ctx.fillText("A (Stand, arms crossed)", 10, app.chair.yA-8);
    }
    if(app.chair.yB!=null){
      ctx.strokeStyle="rgba(251,191,36,.95)"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(0,app.chair.yB); ctx.lineTo(canvas.width,app.chair.yB); ctx.stroke();
      ctx.fillStyle="rgba(251,191,36,.95)";
      ctx.fillText("B (Sit, arms crossed)", 10, app.chair.yB-8);
    }
  } else {
    const leg = $("balanceLeg").value;
    const target = (leg==="left") ? app.balance.left : app.balance.right;
    if(target.yA!=null){
      ctx.strokeStyle="rgba(147,197,253,.95)"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(0,target.yA); ctx.lineTo(canvas.width,target.yA); ctx.stroke();
      ctx.fillStyle="rgba(147,197,253,.95)";
      ctx.fillText("A (Stable)", 10, target.yA-8);
    }
  }
}

async function loop(){
  if(app.stopFlag || !app.detector || !app.camOn) return;

  let pose = null;
  try{
    const poses = await app.detector.estimatePoses(video, {maxPoses:1, flipHorizontal:true});
    pose = poses?.[0] || null;
  }catch(e){
    pose = null;
  }

  app.lastPose = pose;
  app.poseConf = poseConfidence(pose);
  $("kpiConf").textContent = app.poseConf ? app.poseConf.toFixed(2) : "—";

  drawPose(pose);

  if($("testMode").value==="chair") updateChair(pose);
  else updateBalance(pose);

  app.rafId = requestAnimationFrame(loop);
}

function zoneFromY(y,yA,yB){
  if(y==null||yA==null||yB==null) return "unknown";
  const tol = Math.abs(yB-yA) * 0.22;
  const dA=Math.abs(y-yA), dB=Math.abs(y-yB);
  if(dA<=tol) return "stand";
  if(dB<=tol) return "sit";
  return (dA<dB) ? "stand" : "sit";
}
function resetChairRun(){
  app.chair.reps = 0;
  app.chair.started = false;
  app.chair.done = false;
  app.chair.startTs = 0;
  app.chair.lastState = "unknown";
  app.chair.lastSwitchTs = 0;
  $("kpiReps").textContent="0";
  $("kpiTimer").textContent="0.0s";
}
function canStartChair(){
  return app.camOn && app.chair.yA!=null && app.chair.yB!=null;
}
function startChair(){
  if(!canStartChair()){
    alert("Please calibrate A (standing) and B (sitting) first.");
    return;
  }
  if(app.chair.yA > app.chair.yB){
    const tmp = app.chair.yA;
    app.chair.yA = app.chair.yB;
    app.chair.yB = tmp;
  }
  resetChairRun();
  app.chair.protocolSec = Number($("chairProtocol").value);
  app.chair.started = true;
  app.chair.startTs = now();
  app.chair.lastSwitchTs = now();
  $("kpiStatus").textContent="Running (Chair)";
  $("hudSub").textContent=`Chair ${app.chair.protocolSec}s`;
}
function finishChair(){
  app.chair.started=false;
  app.chair.done=true;
  $("kpiStatus").textContent="Chair Completed";
  $("pChair").textContent=`${app.chair.reps} reps (${app.chair.protocolSec}s)`;
  checkFinishReady();
}
function updateChair(pose){
  $("hudMode").textContent="Chair";
  $("kpiReps").textContent = String(app.chair.reps);
  if(!app.chair.started){
    $("kpiStatus").textContent="Ready (Chair)";
    return;
  }
  const elapsed = (now()-app.chair.startTs)/1000;
  $("kpiTimer").textContent = elapsed.toFixed(1)+"s";
  if(elapsed>=app.chair.protocolSec){ finishChair(); return; }
  const y = pose ? midY(pose) : null;
  if(app.poseConf < 0.25 || y==null) return;
  const state = zoneFromY(y, app.chair.yA, app.chair.yB);
  const t = now();
  const minGap = 450;
  if(app.chair.lastState==="sit" && state==="stand" && (t-app.chair.lastSwitchTs)>minGap){
    app.chair.reps++;
    app.chair.lastSwitchTs=t;
    $("kpiReps").textContent = String(app.chair.reps);
  }
  if(state!=="unknown") app.chair.lastState = state;
}

function liftedFootOk(pose, stanceLeg){
  const support = kp(pose, stanceLeg==="left" ? "left_ankle" : "right_ankle");
  const lift    = kp(pose, stanceLeg==="left" ? "right_ankle" : "left_ankle");
  if(!support||!lift) return false;
  if((support.score??0)<0.2||(lift.score??0)<0.2) return false;
  return (support.y - lift.y) > (canvas.height*0.03);
}
function balanceLost(pose, stanceLeg, yA){
  if(!pose||yA==null) return true;
  if(!liftedFootOk(pose, stanceLeg)) return true;
  const y=midY(pose), x=midX(pose);
  const tolY=canvas.height*0.04, tolX=canvas.width*0.07;
  if(y==null || Math.abs(y-yA)>tolY) return true;
  if(app.balance._x0==null && x!=null) app.balance._x0=x;
  if(x!=null && app.balance._x0!=null && Math.abs(x-app.balance._x0)>tolX) return true;
  const support = kp(pose, stanceLeg==="left" ? "left_ankle" : "right_ankle");
  if(support && (support.score??0)>0.2){
    if(app.balance._a0==null) app.balance._a0={x:support.x,y:support.y};
    const dx=Math.abs(support.x-app.balance._a0.x);
    const dy=Math.abs(support.y-app.balance._a0.y);
    if(dx>canvas.width*0.09 || dy>canvas.height*0.07) return true;
  }
  return false;
}
function canStartBalance(){
  const leg = $("balanceLeg").value;
  const target = (leg==="left") ? app.balance.left : app.balance.right;
  return app.camOn && target.yA!=null;
}
function startBalance(){
  if(!canStartBalance()){
    alert("Please calibrate A (stable stance) first for this leg.");
    return;
  }
  const leg = $("balanceLeg").value;
  app.balance.runningLeg = leg;
  app.balance.started = true;
  app.balance.stableStarted = false;
  app.balance.stableTs = 0;
  app.balance.startTs = 0;
  app.balance._x0=null;
  app.balance._a0=null;
  $("kpiReps").textContent = "—";
  $("kpiTimer").textContent = "0.0s";
  $("kpiStatus").textContent = "Stabilising…";
  $("hudSub").textContent = `Balance ${leg.toUpperCase()}`;
}
function finishBalance(seconds){
  app.balance.started=false;
  const leg=app.balance.runningLeg;
  const target=(leg==="left")?app.balance.left:app.balance.right;
  target.time=clamp(seconds,0,120);
  target.done=true;
  $("kpiStatus").textContent=`Balance ${leg.toUpperCase()} Completed`;
  if(leg==="left") $("pBalL").textContent=`${target.time.toFixed(1)}s`;
  else $("pBalR").textContent=`${target.time.toFixed(1)}s`;
  checkFinishReady();
}
function updateBalance(pose){
  $("hudMode").textContent="Balance";
  $("kpiReps").textContent="—";
  if(!app.balance.started){
    $("kpiStatus").textContent="Ready (Balance)";
    return;
  }
  const leg = app.balance.runningLeg;
  const target = (leg==="left") ? app.balance.left : app.balance.right;
  const t = now();
  if(!app.balance.stableStarted){
    const y = pose ? midY(pose) : null;
    const confOk = app.poseConf >= 0.25;
    $("kpiStatus").textContent="Stabilising…";
    $("kpiTimer").textContent="0.0s";
    if(confOk && y!=null && target.yA!=null){
      const close = Math.abs(y-target.yA) <= canvas.height*0.025;
      const okLift = liftedFootOk(pose, leg);
      if(close && okLift){
        if(!app.balance.stableTs) app.balance.stableTs=t;
        if((t-app.balance.stableTs)>=500){
          app.balance.stableStarted=true;
          app.balance.startTs=t;
          $("kpiStatus").textContent=`Running (Balance ${leg.toUpperCase()})`;
        }
      } else app.balance.stableTs=0;
    }
    return;
  }
  const elapsed = (t-app.balance.startTs)/1000;
  $("kpiTimer").textContent = elapsed.toFixed(1)+"s";
  $("kpiStatus").textContent = `Running (Balance ${leg.toUpperCase()})`;
  const lost = (app.poseConf<0.25) || balanceLost(pose, leg, target.yA);
  if(lost) finishBalance(elapsed);
}

function updateCalibInfo(){
  if($("testMode").value==="chair"){
    $("calibInfo").textContent = `A: ${app.chair.yA!=null?Math.round(app.chair.yA):"—"} | B: ${app.chair.yB!=null?Math.round(app.chair.yB):"—"}`;
  } else {
    const leg=$("balanceLeg").value;
    const target=(leg==="left")?app.balance.left:app.balance.right;
    $("calibInfo").textContent = `A: ${target.yA!=null?Math.round(target.yA):"—"} | B: —`;
  }
}

$("btnCalA").onclick=()=>{
  if(!app.lastPose){ alert("No pose detected yet. Ensure the person is fully visible and wait 1–2 seconds."); return; }
  const y = midY(app.lastPose);
  if(y==null){ alert("Cannot detect body position. Improve lighting / full body in frame."); return; }
  if($("testMode").value==="chair"){
    app.chair.yA = y;
    $("hudSub").textContent = "A saved (Standing)";
  } else {
    const leg=$("balanceLeg").value;
    const target=(leg==="left")?app.balance.left:app.balance.right;
    target.yA = y;
    $("hudSub").textContent = `A saved (Balance ${leg.toUpperCase()})`;
  }
  updateCalibInfo();
};
$("btnCalB").onclick=()=>{
  if($("testMode").value!=="chair"){
    alert("Balance test uses only Position A calibration.");
    return;
  }
  if(!app.lastPose){ alert("No pose detected yet. Ensure the person is fully visible and wait 1–2 seconds."); return; }
  const y = midY(app.lastPose);
  if(y==null){ alert("Cannot detect body position. Improve lighting / full body in frame."); return; }
  app.chair.yB = y;
  $("hudSub").textContent = "B saved (Sitting)";
  updateCalibInfo();
};
$("btnStartTest").onclick=()=>{
  if($("testMode").value==="chair") startChair();
  else startBalance();
};
$("btnStopTest").onclick=()=>{
  app.chair.started=false;
  app.balance.started=false;
  $("kpiStatus").textContent="Stopped";
  $("hudSub").textContent="Ready";
};
$("btnRestartCam").onclick=async()=>{
  try{ await startCamera(); updateCalibInfo(); }
  catch(e){ console.error(e); alert("Camera restart failed. Refresh and try again."); }
};

$("testMode").onchange=()=>{
  const mode = $("testMode").value;
  $("chairOptions").classList.toggle("hidden", mode!=="chair");
  $("balanceOptions").classList.toggle("hidden", mode!=="balance");
  $("btnCalB").disabled = (mode!=="chair");
  $("hudSub").textContent = (mode==="chair") ? "Chair ready" : "Balance ready";
  $("kpiReps").textContent = (mode==="chair") ? String(app.chair.reps) : "—";
  updateCalibInfo();
};
$("balanceLeg").onchange=()=>updateCalibInfo();

$("btnManualChair").onclick=()=>{
  const sec = Number($("chairProtocol").value);
  const reps = prompt(`Enter chair stand reps completed in ${sec} seconds:`);
  if(reps==null) return;
  const n = Number(reps);
  if(!Number.isFinite(n) || n<0){ alert("Invalid number."); return; }
  app.chair.protocolSec = sec;
  app.chair.reps = Math.round(n);
  app.chair.done = true;
  app.chair.started = false;
  $("pChair").textContent = `${app.chair.reps} reps (${sec}s)`;
  checkFinishReady();
};
$("btnManualBalance").onclick=()=>{
  const leg=$("balanceLeg").value;
  const sec=prompt(`Enter single-leg balance time for ${leg.toUpperCase()} leg (seconds):`);
  if(sec==null) return;
  const n=Number(sec);
  if(!Number.isFinite(n) || n<0){ alert("Invalid number."); return; }
  const target=(leg==="left")?app.balance.left:app.balance.right;
  target.time = clamp(n,0,120);
  target.done = true;
  if(leg==="left") $("pBalL").textContent = `${target.time.toFixed(1)}s`;
  else $("pBalR").textContent = `${target.time.toFixed(1)}s`;
  checkFinishReady();
};

function chairInterpretation(){
  const u=app.user, reps=app.chair.reps, sec=app.chair.protocolSec;
  if(sec===30){
    const band=ageBand30(u.age);
    const norm=band?chair30Norms[band][u.gender]:null;
    if(!band||norm==null){
      return { title:"30s Chair Stand", ref:"Reference not available for this age band.", verdict:`${reps} reps`, cls:"muted",
        detail:"Use your result as a baseline and track improvement over time." };
    }
    const ok=reps>=norm;
    return {
      title:"30s Chair Stand",
      ref:`Reference (Age ${band}, ${u.gender==="men"?"Men":"Women"}): ${norm} reps`,
      verdict:`${reps} reps — ${ok?"Meets or above reference":"Below reference"}`,
      cls: ok ? "ok" : "warn",
      detail:"Strength can improve with safe training (sit-to-stand practice, step-ups, resistance training)."
    };
  } else {
    const ref=chair1MinRef(u.age);
    if(!ref){
      return { title:"1-Min Chair Stand", ref:"Reference not available for this age.", verdict:`${reps} reps`, cls:"muted",
        detail:"Use your result as a baseline and track improvement over time." };
    }
    let cls="warn", verdict="Below typical range";
    if(reps>=ref.low && reps<=ref.high){ cls="ok"; verdict="Within typical range"; }
    if(reps>ref.high){ cls="ok"; verdict="Above typical range"; }
    return { title:"1-Min Chair Stand", ref:`Typical range: ${ref.low}–${ref.high}+ reps`, verdict:`${reps} reps — ${verdict}`, cls,
      detail:"Extra endurance marker. Progress gradually to avoid over-fatigue." };
  }
}

function buildResultsHTML(){
  const u=app.user;
  const chair=chairInterpretation();
  const balL=interpretBalance(app.balance.left.time);
  const balR=interpretBalance(app.balance.right.time);
  return `
    <div class="badge">Participant: <strong>${escapeHtml(u.name)}</strong> • Age: <strong>${u.age}</strong> • Gender: <strong>${u.gender==="men"?"Male":"Female"}</strong></div>
    <div class="badge">HP: <strong>${escapeHtml(u.phone)}</strong></div>
    <div class="hr"></div>
    <h2>${chair.title}</h2>
    <p class="small muted">${chair.ref}</p>
    <p class="${chair.cls}" style="font-weight:900">${chair.verdict}</p>
    <p class="small">${chair.detail}</p>
    <div class="hr"></div>
    <h2>Single-Leg Balance</h2>
    <p><strong>Left:</strong> ${app.balance.left.time!=null ? app.balance.left.time.toFixed(1)+"s" : "—"} <span class="${balL.cls} small">(${balL.label})</span></p>
    <p><strong>Right:</strong> ${app.balance.right.time!=null ? app.balance.right.time.toFixed(1)+"s" : "—"} <span class="${balR.cls} small">(${balR.label})</span></p>
    <div class="notice small" style="margin-top:10px">
      <strong>Encouragement:</strong> Strength and balance can improve at any age with consistent, safe training.
      If you want a personalised plan, contact Coach Daniel.
    </div>
  `;
}

function saveLocal(){
  const payload={
    savedAt:new Date().toISOString(),
    user:app.user,
    chair:{ protocolSec:app.chair.protocolSec, reps:app.chair.reps, yA:app.chair.yA, yB:app.chair.yB },
    balance:{ left:app.balance.left.time, right:app.balance.right.time }
  };
  localStorage.setItem("coachDanielSPPB_last", JSON.stringify(payload));
  return payload;
}
function loadLocal(){
  const raw=localStorage.getItem("coachDanielSPPB_last");
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function checkFinishReady(){
  $("btnFinish").disabled = !(app.chair.done && app.balance.left.done && app.balance.right.done);
}

function exportPdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const u=app.user || {name:"",age:"",gender:"",phone:""};
  const genderLabel = u.gender==="men" ? "Male" : (u.gender==="women" ? "Female" : "");
  const chair=chairInterpretation();
  const balL=interpretBalance(app.balance.left.time);
  const balR=interpretBalance(app.balance.right.time);
  const margin=48;
  let y=56;
  const addText=(text,size=12,bold=false)=>{
    doc.setFont("helvetica", bold ? "bold" : "normal");
    doc.setFontSize(size);
    const lines=doc.splitTextToSize(text, 595 - margin*2);
    doc.text(lines, margin, y);
    y += lines.length * (size + 4);
  };
  const hr=()=>{
    y += 6;
    doc.setDrawColor(200);
    doc.line(margin, y, 595 - margin, y);
    y += 14;
  };
  addText("Senior Physical Performance Battery Test", 18, true);
  addText("Welcome to Coach Daniel SPPB Test", 12, false);
  hr();
  addText(`Participant: ${u.name}`, 12, true);
  addText(`Age: ${u.age}   Gender: ${genderLabel}`, 12, false);
  addText(`HP: ${u.phone}`, 12, false);
  addText(`Date: ${new Date().toLocaleString()}`, 11, false);
  hr();
  addText(chair.title, 14, true);
  addText(`Result: ${app.chair.reps} reps (${app.chair.protocolSec}s)`, 12, false);
  addText(`Reference: ${chair.ref}`, 11, false);
  addText(`Interpretation: ${chair.verdict}`, 11, true);
  addText(`Notes: ${chair.detail}`, 11, false);
  hr();
  addText("Single-Leg Balance", 14, true);
  addText(`Left:  ${app.balance.left.time!=null ? app.balance.left.time.toFixed(1)+"s" : "—"}  (${balL.label})`, 11, false);
  addText(`Right: ${app.balance.right.time!=null ? app.balance.right.time.toFixed(1)+"s" : "—"}  (${balR.label})`, 11, false);
  hr();
  addText("Important Safety & Disclaimer", 12, true);
  addText("This assessment is for fitness screening and education only. It is not a medical diagnosis.", 10, false);
  addText("Stop immediately if you feel dizzy, chest pain, severe breathlessness, sharp joint pain, or unsafe.", 10, false);
  addText("If you have frequent falls or concerning symptoms, consult a healthcare professional.", 10, false);
  hr();
  addText("Contact", 12, true);
  addText("Coach Daniel Phua • HP: 98163603", 12, false);
  const safeName=(u.name||"Participant").replace(/[^\w\-]+/g,"_");
  doc.save(`CoachDaniel_SPPB_${safeName}_${Date.now()}.pdf`);
}

$("btnStart").onclick=()=>show("screenRegister");
$("btnBack1").onclick=()=>show("screenWelcome");
$("btnBack2").onclick=()=>show("screenRegister");
$("btnBack3").onclick=()=>show("screenGuide");

$("btnLoadLast").onclick=()=>{
  const p=loadLocal();
  if(!p){ alert("No saved results found on this device yet."); return; }
  show("screenResults");
  $("resultsBlock").innerHTML = `
    <h2>Last Saved Result</h2>
    <pre class="small" style="white-space:pre-wrap; color: var(--muted)">${escapeHtml(JSON.stringify(p,null,2))}</pre>
  `;
};

$("btnContinue1").onclick=()=>{
  const name=$("fName").value.trim();
  const age=Number($("fAge").value);
  const gender=$("fGender").value;
  const phone=$("fPhone").value.trim();
  if(!name || !age || !gender || !phone){ alert("Please complete name, age, gender, and HP no."); return; }
  if(!($("cAgree1").checked && $("cAgree2").checked && $("cAgree3").checked)){ alert("Please tick all consent checkboxes to proceed."); return; }
  app.user={name,age,gender,phone};
  show("screenGuide");
};

$("btnContinue2").onclick=async()=>{
  show("screenTests");
  try{
    await startCamera();
    updateCalibInfo();
  }catch(e){
    console.error(e);
    alert("Camera could not be started. Please allow camera permissions and try again.");
  }
};

$("btnFinish").onclick=()=>{
  saveLocal();
  show("screenResults");
  $("resultsBlock").innerHTML=buildResultsHTML();
};
$("btnExport").onclick=()=>{
  const payload=saveLocal();
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="CoachDaniel_SPPB_Result.json"; a.click();
  URL.revokeObjectURL(url);
};
$("btnExportPdf").onclick=()=>{
  try{ saveLocal(); exportPdf(); }
  catch(e){ console.error(e); alert("PDF export failed. Try JSON export."); }
};
$("btnCopyContact").onclick=async()=>{
  const text="Coach Daniel Phua\nHP: 98163603";
  try{ await navigator.clipboard.writeText(text); alert("Coach contact copied."); }
  catch(e){ prompt("Copy this contact:", text); }
};
$("btnRestart").onclick=()=>location.reload();

show("screenWelcome");
</script>
</body>
</html>
